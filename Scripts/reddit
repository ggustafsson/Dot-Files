#!/usr/bin/env ruby

# Written by GÃ¶ran Gustafsson <gustafsson.g@gmail.com>.

# Description: This script automatically opens up all new posts found in
# specificed subreddits under new browser tabs. It keeps track of all the URLs
# opened at the last run.

# The subreddits that are supposed to be checked should be specified in the
# file ~/.reddit/config like this:
#
# aww
# funny
# pics
# wtf

# Usage: reddit

require "fileutils"
require "json"
require "open-uri"

if RUBY_PLATFORM.include?("darwin")
  $browser = "open"
else
  $browser = "firefox"
end

$directory = "#{Dir.home}/.reddit"
$filter_gifs = 1 # GIFs makes Safari go bananas :(
$first_run = 1

if ARGV.length == 1
  config = ARGV[0]
else
  config = "#{$directory}/config"
end


def check_subreddit(subreddit)
  new_file = "#{$directory}/r_#{subreddit}_tmp"
  old_file = "#{$directory}/r_#{subreddit}"
  old_urls = []

  puts if $first_run != 1
  puts "Checking r/#{subreddit} for new posts..."

  fetched_json = open("http://reddit.com/r/#{subreddit}.json").read
  parsed_json = JSON.parse(fetched_json)

  if File.exist?(old_file)
    File.readlines(old_file).each do |line|
      old_urls << Regexp.escape(line.strip)
    end
  end

  file = File.open(new_file, "w")

  parsed_json["data"]["children"].each do |post|
    url = post["data"]["url"]

    file.puts url

    if $filter_gifs == 1
      next if url.include?(".gif")
    end

    if !old_urls.empty?
      open_url(url) unless old_urls.include?(Regexp.escape(url))
    else
      open_url(url)
    end
  end

  file.close
  FileUtils.mv(new_file, old_file)

  $first_run = 0
end

def open_url(url)
  puts "Opening URL: #{url}"
  `#{$browser} "#{url}"`
end


unless File.directory?($directory)
  puts "Directory '#{$directory}' doesn't exist! Creating it..."
  Dir.mkdir($directory)
end

unless File.exist?(config)
  abort "File '#{config}' doesn't exist! Exiting..."
end

File.readlines(config).each do |line|
  check_subreddit(line.strip)
end
